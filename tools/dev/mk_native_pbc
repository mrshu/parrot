#!/bin/sh

# sh tools/dev/mk_native_pbc [--noconf] [config_opts...]
#
# Generate/update t/native_pbc/*_*.pbc
# This should only be run on known systems to regenerate the native pbcs.
# You need at least a multilib 64bit intel and powerpc machine to generate all.
# QEMU images of big-endian 64bit machines are still being worked on,
#   still openbios problems on SPARC64 qemu.
#
# Without --noconf all known floatval types are tried to be generated.
# float, double, long double, __float128
#
# NOTE: Installing ccache speeds this process up considerably.
# E.g.
# tools/dev/mk_native_pbc --m=32 --cc='ccache cc' --without-icu
# tools/dev/mk_native_pbc --cc='ccache cc' --without-icu

i_id=
n_id=
conf="$@"
exe=
targets="parrot parrot_config pbc_dump"

initconfig () {
    test -e parrot_config || exit
    byteorder=$(./parrot_config byteorder)
    ptrsize=$(./parrot_config ptrsize)
    intvalsize=$(./parrot_config intvalsize)
    # 4, 8, 12, 16
    numvalsize=$(./parrot_config numvalsize)
    hugefloatvalsize=$(./parrot_config hugefloatvalsize)
    # 4, 8, 10, 16, 16PPC, 16AIX, 16MIPS
    floattype=$(./parrot_config floattype|sed 's,FLOATTYPE_,,')
    if [ "$(echo $byteorder|cut -c1-2)" = "12" ]; then
	suffix=le
    else
	suffix=be
    fi
    i_id=${intvalsize}_${suffix}
    n_id=${intvalsize}_${floattype}_${suffix}
}

createpbc () {
    for T in integer string
    do
	./parrot -o t/native_pbc/${T}_${i_id}.pbc t/native_pbc/testdata/${T}.pasm && \
	    echo "t/native_pbc/${T}_${i_id}.pbc updated"
    done
    for T in number
    do
	./parrot -o t/native_pbc/${T}_${n_id}.pbc t/native_pbc/testdata/${T}.pasm && \
	    echo "t/native_pbc/${T}_${n_id}.pbc updated"
    done
}

echo ""
tail -n4 myconfig
echo make -s $targets
make -s $targets || exit 1

initconfig

if [ "$(./parrot_config osname)" = "cygwin" ]; then exe=.exe; fi
if [ "$ptrsize" = "4" -a "$intvalsize" != "4" ]; then
    echo "Sorry, unsupported perl - probably using use64bitint. ptrsize/intvalsize mismatch."
    exit
fi

createpbc

#make pbc_dump$exe
#./pbc_dump -h t/native_pbc/number_${id}.pbc
perl tools/dev/pbc_header.pl t/native_pbc/number_${n_id}.pbc
perl t/harness t/native_pbc/integer.t t/native_pbc/number.t t/native_pbc/string.t

# reconfigure with various floatvals
reconfig () {
    floatval="$1"
    shift
    make -s prog-clean
    confargs="--nomanicheck --without-icu --without-pcre --without-gmp --without-libffi --without-opengl"
    echo perl Configure.pl --floatval="$floatval" $confargs $@
    perl Configure.pl --floatval="$floatval" $conf $confargs $@
    tail -n4 myconfig
    echo make -s $targets
    make -s $targets || return
    initconfig
    ./parrot -o t/native_pbc/number_${n_id}.pbc t/native_pbc/testdata/number.pasm \
	&& echo "t/native_pbc/number_${n_id}.pbc updated"
    perl tools/dev/pbc_header.pl t/native_pbc/number_${n_id}.pbc
    perl t/harness t/native_pbc/number.t
}

if [ "x$1" != "x--noconf" ]
then
    case "$numvalsize" in
	"4")
	    reconfig "double" $conf
	    reconfig "long double" $conf
	    reconfig "__float128" $conf
	    ;;
	"8")
	    if [ "$hugefloatvalsize" != "8" ]; then
		reconfig "long double" $conf
	    fi
	    reconfig "float" $conf
	    reconfig "__float128" $conf
	    ;;
	"12")
	    reconfig "double" $conf
	    reconfig "float" $conf
	    reconfig "__float128" $conf
	    ;;
	"16")
	    reconfig "double" $conf
	    reconfig "float" $conf
	    if [ "$floattype" != "16" ]; then
		reconfig "__float128" $conf
	    fi
	    ;;
    esac
fi

echo "You should run these commands to update the PBC files in your repo:"
echo "git add t/native_pbc/*.pbc"
echo "git commit -m 'native_pbc platform updates'"
